<!DOCTYPE html>
<html>
	<head>
    <meta charset="utf-8"/>
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"/>
		<!-- <meta http-equiv="X-UA-Compatible" content="ie=edge"/> -->
		<link type="text/css" rel="stylesheet" href="main.css">

		<title>My second gear test</title>
	</head>

	<body>
		<div id = "info">
			<a href="https://github.com/petrokvitka" target="_blank" rel="noopener">petrokvitka</a>
			" - Gear Loading Test."
		</div>

		<script type="module">

			import * as THREE from './js/three.module.js';
			import Stats from './js/stats.module.js';
			import { STLLoader } from './js/STLLoader.js';

			var container, stats;

			var camera, cameraTarget, scene, renderer;

			init();
			animate();

			function init() {

				container = document.createElement( 'div' );
				document.body.appendChild( container );
				camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 1, 15);
				camera.position.set(3, 0.15, 3);

				cameraTarget = new THREE.Vector3(0, -0.25, 0);

				scene = new THREE.Scene();
				scene.background = new THREE.Color( 0x72645b );
				scene.fog = new THREE.Fog( 0x72645b, 2, 15);

				// ground

				var plane = new THREE.Mesh(
					new THREE.PlaneBufferGeometry(40, 40),
					new THREE.MeshPhongMaterial({ color: 0x999999, specular: 0x101010 })
				);
				plane.rotation.x = -Math.PI / 2
				plane.position.y = -0.5;
				scene.add(plane);

				plane.receiveShadow = true;

				// ascii file
				var loader = new STLLoader();
				loader.load('gear.STL', function(geometry){
					var material = new THREE.MeshStandardMaterial({
						color: 0x888888,
						roughness: 0.2,
						metalness: 0.9
					});

					var mesh = new THREE.Mesh(geometry, material);

					mesh.position.set(0, -0.25, 0.6);
					mesh.rotation.set(0, -Math.PI / 2, 0);
					mesh.scale.set(0.5, 0.5, 0.5);

					mesh.castShadow = true;
					mesh.receiveShadow = true;

					scene.add(mesh);

				});

				// lights
				scene.add(new THREE.HemisphereLight( 0x443333, 0x111122 ));

				addShadowedLight(1, 1, 1, 0xffffff, 1.35);
				addShadowedLight(0.5, 1, -1, 0xffaa00, 1);

				//renderer
				renderer = new THREE.WebGLRenderer({ antialias: true });
				renderer.setPixelRatio(window.devicePixelRatio);
				renderer.setSize(window.innerWidth, window.innerHeight);
				renderer.outputEncoding = THREE.sRGBEncoding;

				renderer.shadowMap.enabled = true;

				container.appendChild(renderer.domElement);

				//stats
				stats = new Stats();
				container.appendChild(stats.dom);

				//
				window.addEventListener( 'resize', onWindowResize, false);

			}

			function addShadowedLight(x, y, z, color, intensity){
				var directionalLight = new THREE.DirectionalLight(color, intensity);
				directionalLight.position.set(x, y, z);
				scene.add(directionalLight);

				directionalLight.castShadow = true;

				var d = 1;
				directionalLight.shadow.camera.left = -d;
				directionalLight.shadow.camera.right = d;
				directionalLight.shadow.camera.top = d;
				directionalLight.shadow.camera.bottom = -d;

				directionalLight.shadow.camera.near = 1;
				directionalLight.shadow.camera.far = 4;

				directionalLight.shadow.bias = -0.002;

			}

			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize(window.innerWidth, window.innerHeight);

			}

			function animate() {
				requestAnimationFrame(animate);

				render();
				stats.update();

			}

			function render() {
				var timer = Date.now() * 0.0005;

				camera.position.x = Math.cos(timer) * 3;
				camera.position.z = Math.sin(timer) * 3;

				camera.lookAt(cameraTarget);

				renderer.render(scene, camera);

			}

		</script>
		<div>
			<canvas width="423" height="1057" style="width: 423px; height: 1057px;">
			<div style="position: fixed; top: 0px; cursor: pointer; opacity: 0.9; z-index:10000;">
				<canvas width="80" height="48" style="width: 80px; height: 48px; display: block;">
				<canvas width="80" height="48" style="width: 80px; height: 48px; display: none;">
				<canvas width="80" height="48" style="width: 80px; height: 48px; display: none;">
			</div>
		</div>
	</body>
</html>
